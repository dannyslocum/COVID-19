<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	
	<style type="text/css">
		.line {
			fill: none;
			stroke: black;
			stroke-width: 1.5;
			opacity: 1;
		}		
		.line-hover {
			stroke: blue;
			stroke-width: 2;
			opacity: 1.5;
		}
		  
		.overlay {
			fill: none;
			pointer-events: all;
		}

		.dot {
			fill: black;
			opacity: .5;
		}		
		dot2 {
			opacity: 1;
		}
		  
		.focus circle {
			fill: none;
			stroke: steelblue;
		}
		div.tooltip {	
			position: absolute;			
			text-align: left;			
			width: 200px;					
			height: auto;					
			padding: 2px;				
			font: 12px sans-serif;		
			background: lightsteelblue;	
			border: 0px;		
			border-radius: 8px;			
			pointer-events: none;			
		}
		#play-button {
			position: absolute;
			top: 140px;
			left: 50px;
			background: #f08080;
			padding-right: 26px;
			border-radius: 3px;
			border: none;
			color: white;
			margin: 0;
			padding: 0 12px;
			width: 60px;
			cursor: pointer;
			height: 30px;
		}

		#play-button:hover {
			background-color: #696969;
		}    
		
		.ticks {
			font-size: 10px;
		}

		.track,
		.track-inset,
		.track-overlay {
			stroke-linecap: round;
		}

		.track {
			stroke: #000;
			stroke-opacity: 0.3;
			stroke-width: 10px;
		}

		.track-inset {
			stroke: #dcdcdc;
			stroke-width: 8px;
		}

		.track-overlay {
			pointer-events: stroke;
			stroke-width: 50px;
			stroke: transparent;
			cursor: crosshair;
		}

		.handle {
			fill: #fff;
			stroke: #000;
			stroke-opacity: 0.5;
			stroke-width: 1.25px;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="row">
			<div class="col-sm-8" id="visual">
				<svg class="mx-auto" width="100%"></svg>
			</div>
			<div class="col-sm-4 text-center" style="margin-top:50px;" id="filterState">
				<label for='stateSelect'>Select State:</label>
				<select id='stateSelect' onchange=update() size=32 multiple></select>
			</div>
			<div class="row">
				<div class="col-sm-5"></div>
				<div class="col-sm-3" style="">
					<input type="radio" class="yscale" name="yscale" value="linear" checked><label for="vehicle1"> Linear Scale</label>
					<br>
					<input type="radio" class="yscale" name="yscale" value="log"><label for="vehicle1"> Log Scale</label><br>
				</div>
			</div>
		</div>
		<div class="row">
			<div id="slider"></div>
			<button id="play">Play</button>
		</div>
	</div>
	<hr>
    <script type="text/javascript">
		// code from:
			// https://bl.ocks.org/officeofjane/47d2b0bfeecfcb41d2212d06d095c763
			// https://bl.ocks.org/officeofjane/47d2b0bfeecfcb41d2212d06d095c763
 		var parseTime = d3.timeParse("%Y-%m-%d");
		var formatTime = d3.timeFormat("%A, %m/%d/%Y");
		var formatDateIntoYear = d3.timeFormat("%m/%d");
		var formatDate = d3.timeFormat("%b %d %Y");
		var parseDate = d3.timeParse("%m/%d/%y");
		var states = [];
		var stateOptions = "";
		var dataset, line, data, data_objects, organize_data;
		var handle, label;
		var tooltip = d3.select("body").append("div")	
				.attr("class", "tooltip")				
				.style("opacity", 0);
		var margin = {top: 50, right: 100, bottom: 50, left: 50};
		var moving = false;

		var play = d3.select("#play");
		play.on("click", function() {
				var button = d3.select(this);
				if (button.text() == "Pause") {
					moving = false;
					clearInterval(timer);
					// timer = 0;
					button.text("Play");
				} else {
					moving = true;
					if (currentValue == targetValue) { currentValue = 0; }
					timer = setInterval(step, 100);
					button.text("Pause");
				}
			});
		
		var currentValue, targetValue, timeScale, timeScale, slider_svg, slider, svg, xScale, xAxis, yScaleLog,
			yScaleLinear, yScale, yAxisLog, yAxisLinear, yAxis, scale;
			
		var width, height;
			
		$(function() {				
			width = window.innerWidth - 100- margin.left - margin.right;
			width = document.getElementById("visual").getElementsByTagName("svg")[0].width;
			width = width.baseVal.value - margin.left - margin.right;
			height = window.innerHeight - 250 - margin.top - margin.bottom;
			currentValue = width;
			targetValue = width;
			timeScale = d3.scaleTime().range([0, targetValue]).clamp(true);

			slider_margin = {top:10, bottom:0};
			slider_height = 100 - slider_margin.top - slider_margin.bottom;
			slider_svg = d3.select("#slider")
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", slider_height + slider_margin.top + slider_margin.bottom);  
			slider = slider_svg.append("g")
					.attr("class", "slider")
					.attr("transform", "translate(" + margin.left + "," + slider_height/2 + ")");
					
			svg = d3.select("#visual svg")
						.attr("class", "mx-auto")
						.attr("height", height + margin.top + margin.bottom)
						.append("g")
							.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			svg.append("g").attr("class", "xaxis").attr("transform", "translate(0," + height + ")");
			svg.append("g").attr("class", "yaxis");
		
			xScale = d3.scaleLinear().range([0, width]);
			xAxis = d3.axisBottom(xScale);

			yScaleLog = d3.scaleLog().range([height, 0]);
			yScaleLinear = d3.scaleLinear().range([height, 0]);
			yScale = yScaleLinear;
			yAxisLog = d3.axisLeft(yScaleLog).ticks(10, formatPower);	
			yAxisLinear = d3.axisLeft(yScaleLinear);
			yAxis = yAxisLinear;
			scale = "linear";
			
			d3.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv", function(d) {
					states.push(d.state);
					return {
						cases: +d.cases,
						deaths: +d.deaths,
						fips: +d.fips,
						date: parseTime(d.date),
						state: d.state
					}
				})
				.then(function(data) {
					createSelectOptions();
					dataset = data.sort(function(x, y){ return d3.ascending(x.date, y.date); });
					createSlider();
					update();
				})
				.catch(function(error) {
					console.log("error loading data")
				});
			
			$("input[name='yscale']").change(function(){
				if (this.value == "linear") {
					scale = "linear";
				} else if (this.value == "log") {
					scale = "log";
				}
				
				setScale();
				setLineTransition();
				setDotTransition();
			});
		});
		function setLineTransition(transition_speed){
			// svg.selectAll('.line').each(function(d, i) { 
			// 	d3.select(this).selectAll('.line')
			//		.transition()
			//			.duration(transition_speed)
			//			.attr("d", function(d) { return line(d.values); });
			// });
			svg.selectAll('.line').transition()
				.duration(transition_speed)
				.attr("d", function(d, i) { return line(organize_data[i]['values']); });
		}
		function setDotTransition(transition_speed){	
			svg.selectAll(".dots").each(function(d, i) {
				state_val = organize_data[i]['key'];
				d3.select(this).selectAll('.dot')
					.attr("cx", function(d, i) { return xScale(i) })
					.attr("cy", function(d, i) { return yScale(getVelocity(i, state_val)); })
					.attr('r', 1.25)
					.style("opacity", 0)
					.transition()
						.duration(transition_speed+1000)
						.style("opacity", 1);
			});			
			svg.selectAll(".dots2").each(function(d, i) { 
				state_val = organize_data[i]['key'];
				d3.select(this).selectAll('.dot2')
					.style("opacity", 0)
					.attr("cx", function(d, i) { return xScale(i) })
					.attr("cy", function(d, i) { return yScale(Math.max(min, getMovingAverage(i, state_val))); })
					.style('fill', function(d,i) { return getAccelerationColor(getAcceleration(i, getMovingAverage, state_val)); })
					.attr('r', 3)
					.transition()
						.duration(transition_speed+1000)
						.style("opacity", 1);
			});
		}
		function prepare(d) {
			d.id = d.id;
			d.date = parseDate(d.date);
			return d;
		}
		function step() {
			update_slider(timeScale.invert(currentValue));
			update();
			currentValue = currentValue + (targetValue/151);
			if (currentValue > targetValue) {
				moving = false;
				currentValue = targetValue;
				clearInterval(timer);
				play.text("Play");
			}
		}
		function createSlider(){
			var startDate = d3.min(dataset, function(d) { return d.date;});
			var endDate = d3.max(dataset, function(d) { return d.date;});
			timeScale.domain([startDate, endDate]);
			
			slider.append("line")
				.attr("class", "track")
				.attr("x1", timeScale.range()[0])
				.attr("x2", timeScale.range()[1])
				.select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
				.attr("class", "track-inset")
				.attr("class", "track-inset")
				.select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
				.attr("class", "track-overlay")
				.call(d3.drag()
						.on("start.interrupt", function() { slider.interrupt(); })
						.on("start drag", function() {
							currentValue = d3.event.x;
							update_slider(timeScale.invert(currentValue)); 
						})
				);

			slider.insert("g", ".track-overlay")
				.attr("class", "ticks")
				.attr("transform", "translate(0," + 18 + ")")
				.selectAll("text")
				.data(timeScale.ticks(10))
				.enter().append("text")
					.attr("x", timeScale)
					.attr("y", 10)
					.attr("text-anchor", "middle")
					.text(function(d) { return formatDateIntoYear(d); });

			handle = slider.insert("circle", ".track-overlay")
				.attr("class", "handle")
				.attr('cx', currentValue)
				.attr("r", 9);

			label = slider.append("text")  
				.attr("class", "label")
				.attr("text-anchor", "middle")
				.text(formatDate(startDate))
				.attr("transform", "translate(0," + (-25) + ")")
				
		}
		function update_slider(h){
			// update position and text of label according to slider scale
			handle.attr("cx", timeScale(h));
			label.attr("x", timeScale(h)).text(formatDate(h));

			// filter data set and redraw plot
			update(5)
		}
		function setScale(transition_speed){
			if (scale == "linear") {
				yScale = yScaleLinear;
				yAxis = yAxisLinear;
				
				min_array = []
				for (var state_val in data_objects) {
					min_val = d3.min(data_objects[state_val], function(d, i){ return getVelocity(i, d.state); });
					min_array.push(min_val);
				}
				min = d3.min(min_array);
			} else if (scale == "log") {
				yScale = yScaleLog;
				yAxis = yAxisLog;
				min = 1;
			}
			
			max_length = []
			for (state_val in data_objects) {
				max_length.push(data_objects[state_val].length);
			}
			xScale.domain([0, d3.max(max_length)]);
			
			max_array = []
			for (state_val in data_objects) {
				max_val = d3.max(data_objects[state_val], function(d, i){ return getVelocity(i, d.state); });
				max_array.push(max_val);
			}
			yScale.domain([min, d3.max(max_array)]);

			line = d3.line()
				.x(function(d, i) { return xScale(i); })
				.y(function(d, i) { return yScale(Math.max(min, getMovingAverage(i, d.state))); })
				.curve(d3.curveMonotoneX);

			svg.selectAll(".xaxis")
				.transition()
					.duration(transition_speed)
					.call(xAxis);
			svg.selectAll(".yaxis")
				.transition()
					.duration(transition_speed)
					.call(yAxis);

		}
		function update(transition_speed=1000){
			var state = $("#stateSelect").val();
			
			var data_filtered = dataset.filter(function(d){ return (state.includes(d.state)) ? true: false; });	
			var data_filtered = data_filtered.filter(function(d){ return (d.date <= timeScale.invert(currentValue)) ? true: false; });	
			var start_threshold = false;
			data = data_filtered.filter(function(d){ 
					if (d.cases < 10 && start_threshold == false) { start_threshold; return false;
					} else if (d.cases >= 10 && start_threshold == false) { start_threshold = true; return true;
					} else { return true; }
				});
			organize_data = organizeData(data);
			data_objects = organizeData(data, 'object');

			setScale(transition_speed);
			
			paths = svg.selectAll('.lines').each(function(d, i){
				if (organize_data[i] != undefined) {				
					d3.select(this).select(".line").attr("id", "line-" + organize_data[i]['key']);
					x = d3.select(this).select(".label")
							.datum(function() {
									return {
										value: organize_data[i]['values'].length - 1,
										state: organize_data[i]['key']
									}
								})
							.attr("transform", function(j) {
									return "translate(" + (xScale(j.value) + 10)  
									+ "," + (yScale(Math.max(min, getMovingAverage(j.value, j.state))) + 5 )+ ")"; 
								})
							x.text(function(j) { return j.state; });
				}
			});
			paths = svg.selectAll('.lines').data(organize_data);
			path = paths.enter()
					.append("g")
						.attr("class", "lines");
			path.append("path")
					.attr("class", "line ")
					.attr("id", function(d) { return "line-" + d.key; })
					.on("mouseover", function(d) {
						d3.select(this).attr("class", "line line-hover");
					})
					.on("mouseout", function(d) {
						d3.select(this).attr("class", "line");
					});
			path.append("text")
				.attr("class", "label")
				.attr("id", function(d) { return "label-" + d.key; })
				.datum(function(d) {
						return {
							value: d.values.length - 1,
							state: d.key
						}
					})
				.attr("transform", function(d, i) {
						return "translate(" + (xScale(d.value) + 10)  
						+ "," + (yScale(Math.max(min, getMovingAverage(d.value, d.state))) + 5 )+ ")"; 
					})
				.attr("x", 5)
				.text(function(d) { return d.state; });
			paths.exit().remove();

	
			svg.selectAll(".dots").remove();
			dots = svg.selectAll(".dots").data(organize_data)
			dott = dots.enter().append('g').attr('class', 'dots');
			dot = dott.selectAll('.dot').data(function(d) { return d.values; });
			dot.enter().append("circle")
				.attr("class", "dot")
				.merge(dot)
				.on("mouseover", function(d, i) { mouseover(d, i); })
				.on("mouseout", mouseout);
			dot.exit().remove();
			dots.exit().remove();	
			
			svg.selectAll(".dots2").remove();
			dots2 = svg.selectAll(".dots2").data(organize_data)
			dott2 = dots2.enter().append('g').attr('class', 'dots2');
			dot2 = dott2.selectAll('.dot2').data(function(d) { return d.values; });
			dot2.enter().append("circle")
				.attr("class", "dot2")
				.merge(dot2)
				.on("mouseover", function(d, i) { mouseover(d, i); })
				.on("mouseout", mouseout);
			dot2.exit().remove();
			dots2.exit().remove();
/*
			dots = svg.selectAll(".dot").data(data);
			dots.enter().append("circle")
				.attr("class", "dot")
				.merge(dots)
				.on("mouseover", function(d, i) { mouseover(d, i); })
				.on("mouseout", mouseout);
			dots.exit().remove();
			
			dots2 = svg.selectAll(".dot2").data(data);
			dots2.enter().append("circle")
				.attr("class", "dot2")
				.merge(dots2)
				.on("mouseover", function(d, i) { mouseover(d, i); })
				.on("mouseout", mouseout);
			dots2.exit().remove();
*/
			setLineTransition(transition_speed);
			setDotTransition(transition_speed);
		}
		function mouseover(d, i) {
			d3.select("path#line-" + d.state + ".line").attr("class", "line line-hover");

			tooltip.transition()		
					.duration(200)		
					.style("opacity", .9);		
			tooltip
				.html("<b>Avg New Cases:</b> " + getMovingAverage(i, d.state) 
						+ "<br/><b>Actual New Cases:</b> " + getVelocity(i, d.state)
						+ "<br/><b>Total Cases:</b> " + d.cases
						+ "<br/><b>Deaths:</b> " + d.deaths
						+ "<br/><b>Date:</b> " + formatTime(d.date)
					)	
				.style("left", (d3.event.pageX) + "px")		
				.style("top", (d3.event.pageY - 28) + "px");
		}
		function mouseout(d) {
			d3.select("path#line-" + d.state + ".line").attr("class", "line");

			tooltip.transition()		
				.duration(500)		
				.style("opacity", 0);	
		}
		function formatPower(x) {
			const e = Math.log10(x);
			if (e !== Math.floor(e)) return; // Ignore non-exact power of ten.
			return `10${(e + "").replace(/./g, c => "⁰¹²³⁴⁵⁶⁷⁸⁹"[c] || "⁻")}`;
		}
		function createSelectOptions() {
			states = d3.set(states).values().sort(d3.ascending);
			for(i=0; i<states.length; i++) {
				if (states[i] == "Virginia") { stateOptions += "<option selected>" + states[i] + "</option>"; } 
				else { stateOptions += "<option>" + states[i] + "</option>"; }
			}
			document.getElementById("stateSelect").innerHTML = stateOptions;
		}
		function organizeData(data, type="entries") {
			if (type == "object") {
				return d3.nest().key(function(d){ return d.state;}).object(data);
			}
			return d3.nest().key(function(d){ return d.state;}).entries(data);
		}
		function getVelocity(i, object){
			state_data = data_objects[object];
			if (scale == "log") {
				if (i==0){ return Math.max(data[i].cases, 1); }
				return Math.max(state_data[i].cases - state_data[i-1].cases, 1);
			} else if (scale == "linear") {
				if (i==0){ return state_data[i].cases; }
				return state_data[i].cases - state_data[i-1].cases;
			}
		}
		function getAcceleration(i, trend_func, object) {
			if (i==0){ num =  0; } 
			else if (i > 0) { num = trend_func(i, object) - trend_func(i-1, object); }
			return num;
		}
		function getAccelerationColor(num) {
			if (num <= 0) { return "green"; }
			else if (num <= 20) { return 'orange'; }
			else if (num <= 50) { return 'lightcoral'; }
			else if (num > 50) { return 'red'; }
		}
		function getMovingAverage(i, object){
			vals = 0
			count = 0
			for (j=0; j<5; j++) {
				if (i-j>0){
					vals += getVelocity(i-j, object);
					count++;
				}
			}
			if (vals == 0) { return 1; }
			return vals/count
		}
    </script>
</body>
</html>